---
title: "generating-tables"
author: "Renze Terpstra"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{generating-tables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
# library(hsstools)
library(devtools)
load_all()
```
# Preparing data
All HSS Toolbox function require three objects to be in memory: A dataframe containing the survey questions, a dictionary of variable names and labels and  a dictionary of value names and labels.
```{r, echo = FALSE}
# create dictionary objects
dict_val <- dummy_val
dict_var <- dummy_var
```

# Using the table creation functions
The HSS Toolbox has several related functions to create different types of frequency tables.
The different types are hss_table_single(), hss_table_multi(), hss_table_overview() and [TBD].

All table functions require you to input a dataframe, a variable name and a disaggregation variable name. Some functions have the 'percent' parameter. This TRUE/FALSE parameter is
used to determine whether output should be shown as a percentage or as counts, by default this is set to TRUE to show percentages. The output for all functions is a dataframe containing the response options and corresponding values for each disaggregation variable.

## Creating a contingency table for a 'select one' question.
To create a contingency table for a survey question where respondents can only choose a single response option, use the hss_table_single() function. This function requires you to input the dataframe with survey questions, the name of the question variable, and the name of the cross-variable. By default the percent option is set to TRUE to display the values as percentage. Set percent to FALSE to display counts.
```{r}
dummydata %>% hss_table_single("occupation", "gender")

dummydata %>% hss_table_single("hhsize", "county", percent = FALSE)
```


## Creating a contingency table for a 'select multiple' question.
To create a contingency table for a question where respondents could select multiple response options, use the hss_table_multi() function. This function requires you to input the dataframe with survey questions, the name of the question variable, and the cross-variable. This function works slightly differently since the names of the different response variables are not entered directly, instead the question variable (usually ending in '_all') is used to search for the corresponding response options. 

If you opt to show values as percentages, not that the percentages shown are the percentage of _respondents_ who selected a particular option, not the percentage of _total answers_. Column totals may therefore add up to more than 100%.

Finally, this function works differently from the 'select one' variant in that the p-values for the different response option's chi-squared statistical tests are appended directly to the output table.
```{r, eval = FALSE}
dummydata %>% hss_table_multi("migr_why_all", "county")

dummydata %>% hss_table_multi("migr_why_all", "county", percent = FALSE)
```
# Adding labels and formatting to generated tables
After you create a frequency table, you can add text labels and formatting to it. To achieve this the table is first converted to a flextable object. The flextable can eventually be exported to Word or PDF.

<!-- NB: add info for formatting function overview tables etc. -->
There are two functions to create a fully formatted tables, one for adding the appropriate text labels and one for adding the appropriate formatting and color options. The labelling and formatting functions work slightly differently. There are two formatting functions hss_format_single() and hss_format_multi() for the different table types. These functions require no additional arguments. The labelling function hss_label() is the same for all table types but requires you to provide the name of the question variable.

```{r}
dummydata %>% hss_table_single("occupation", "gender") %>% 
  hss_format_single() %>%
  hss_label("occupation")
```

```{r}
dummydata %>% hss_table_multi("migr_why_all", "county") %>%
  hss_format_single() %>%
  hss_label("migr_why_all")
```
# Automation
There are two groups of functions used to create and export tables based on a provided list of question variable names.

See also the hss_create_question_list() function, wich uses the Kobo script file (XLS form) to create a list of question variable names paired with their question type.

hss_write_tables() and hss_write_formatted() create a list of named dataframes with contingency tables for the question variable names provided. Note that both functions fail silently in case an error occurs with any of the provided question variable names.

hss_export_tables() and hss_export_formatted() take the list of named dataframes and write it to a .csv file or a Word file respectively.

## Exporting tables to .csv file

```{r, eval = FALSE}
questions <- questions <- c(select_one = "gender", select_one = "occupation", 
               select_one = "occupation_wagetype", select_one = "residence", 
               select_one = "migr_nr", select_multiple = "migr_why_all")

hss_write_tables(dummydata, questions, "gender") %>%
  hss_export_tables("./tables.csv")
```

## Exporting formatted tables to Word
```{r, eval = FALSE}
questions <- questions <- c(select_one = "gender", select_one = "occupation", 
               select_one = "occupation_wagetype", select_one = "residence", 
               select_one = "migr_nr", select_multiple = "migr_why_all") 
hss_write_formatted(questions, "county") %>% 
  hss_export_formatted("./formatted_tables.docx")
```

